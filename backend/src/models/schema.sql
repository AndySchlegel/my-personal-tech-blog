-- =============================================================
-- Database Schema for My Personal Tech Blog
-- PostgreSQL on AWS RDS (db.t3.micro)
--
-- Tables: users, categories, posts, tags, post_tags, comments
-- =============================================================

-- ----- USERS -----
-- Admin users managed by AWS Cognito.
-- We store a local reference so we can link posts to authors.
CREATE TABLE users (
  id            SERIAL PRIMARY KEY,
  cognito_id    VARCHAR(255) UNIQUE NOT NULL,  -- Cognito "sub" (unique user ID)
  email         VARCHAR(255) UNIQUE NOT NULL,
  display_name  VARCHAR(100) NOT NULL,
  role          VARCHAR(20) DEFAULT 'admin',   -- 'admin' or 'editor'
  created_at    TIMESTAMP DEFAULT NOW()
);

-- ----- CATEGORIES -----
-- Each blog post belongs to one category.
-- Examples: "AWS & Cloud", "Homelab", "Certifications", "DevOps"
CREATE TABLE categories (
  id            SERIAL PRIMARY KEY,
  name          VARCHAR(100) UNIQUE NOT NULL,   -- Display name
  slug          VARCHAR(100) UNIQUE NOT NULL,   -- URL-friendly: "aws-and-cloud"
  description   TEXT,
  created_at    TIMESTAMP DEFAULT NOW()
);

-- ----- POSTS -----
-- The main content table. Stores blog articles as Markdown.
CREATE TABLE posts (
  id                    SERIAL PRIMARY KEY,
  title                 VARCHAR(255) NOT NULL,
  slug                  VARCHAR(255) UNIQUE NOT NULL,   -- URL-friendly: "my-first-post"
  content               TEXT NOT NULL,                   -- Markdown content
  excerpt               TEXT,                            -- Short summary for post list
  cover_image_url       VARCHAR(500),                    -- S3 URL for cover image
  status                VARCHAR(20) DEFAULT 'draft',     -- 'draft', 'published', 'archived'
  featured              BOOLEAN DEFAULT FALSE,           -- Show on homepage highlight
  reading_time_minutes  INTEGER DEFAULT 0,               -- Estimated read time
  view_count            INTEGER DEFAULT 0,
  author_id             INTEGER REFERENCES users(id),
  category_id           INTEGER REFERENCES categories(id),
  published_at          TIMESTAMP,                       -- NULL until published
  created_at            TIMESTAMP DEFAULT NOW(),
  updated_at            TIMESTAMP DEFAULT NOW()
);

-- Index for fast lookups by slug (every page visit uses this)
CREATE INDEX idx_posts_slug ON posts(slug);
-- Index for listing published posts sorted by date
CREATE INDEX idx_posts_published ON posts(status, published_at DESC);

-- ----- TAGS -----
-- Tags can be added manually OR auto-generated by Amazon Comprehend.
-- The "source" column tracks where the tag came from.
CREATE TABLE tags (
  id            SERIAL PRIMARY KEY,
  name          VARCHAR(100) UNIQUE NOT NULL,   -- Display name: "AWS", "Docker"
  slug          VARCHAR(100) UNIQUE NOT NULL,   -- URL-friendly: "aws", "docker"
  source        VARCHAR(20) DEFAULT 'manual',   -- 'manual' or 'comprehend'
  created_at    TIMESTAMP DEFAULT NOW()
);

-- ----- POST_TAGS -----
-- Junction table: connects posts to tags (many-to-many).
-- A post can have multiple tags, a tag can be on multiple posts.
CREATE TABLE post_tags (
  post_id       INTEGER REFERENCES posts(id) ON DELETE CASCADE,
  tag_id        INTEGER REFERENCES tags(id) ON DELETE CASCADE,
  confidence    REAL,              -- Comprehend confidence score (0.0 - 1.0), NULL for manual tags
  PRIMARY KEY (post_id, tag_id)    -- Each post-tag combination is unique
);

-- ----- COMMENTS -----
-- Reader comments on blog posts. No login required to comment.
-- Sentiment is analyzed by Amazon Comprehend after submission.
CREATE TABLE comments (
  id              SERIAL PRIMARY KEY,
  post_id         INTEGER REFERENCES posts(id) ON DELETE CASCADE,
  author_name     VARCHAR(100) NOT NULL,         -- Commenter's display name
  author_email    VARCHAR(255),                   -- Optional, not displayed publicly
  content         TEXT NOT NULL,
  sentiment       VARCHAR(20),                    -- Comprehend result: 'POSITIVE', 'NEGATIVE', 'NEUTRAL', 'MIXED'
  sentiment_score REAL,                           -- Confidence score (0.0 - 1.0)
  status          VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'approved', 'flagged', 'deleted'
  created_at      TIMESTAMP DEFAULT NOW()
);

-- Index for listing comments per post
CREATE INDEX idx_comments_post ON comments(post_id, created_at DESC);
