# Infrastructure Provision Pipeline
#
# MANUAL TRIGGER ONLY (workflow_dispatch) -- security scan + deploy all
# infrastructure in one pipeline run.
#
# Three jobs in sequence:
#   1. VALIDATE      - Format check, init, validate (no AWS needed)
#   2. SECURITY SCAN - tfsec + Checkov strict (must pass before any infra changes)
#   3. PROVISION     - Apply Wave 1 then Wave 2 (dependency order)
#
# Provision order matters (dependency chain):
#   1. Wave 1 first (VPC, SGs, ECR, S3, Cognito, OIDC -- base infrastructure)
#   2. Wave 2 second (RDS depends on VPC subnets + security groups)
#
# Authentication: OIDC federation (same IAM role as other workflows).
#
# Required GitHub Secrets:
#   AWS_ROLE_ARN  - IAM role ARN from terraform output github_actions_role_arn
#   DB_PASSWORD   - Database master password (same as terraform.tfvars)

name: Infrastructure Provision

on:
  workflow_dispatch:

# OIDC requires these permissions to request and present the JWT token.
permissions:
  id-token: write
  contents: read

# Same concurrency group as terraform.yml -- prevents state conflicts.
concurrency:
  group: terraform-apply
  cancel-in-progress: false

env:
  AWS_REGION: eu-central-1
  TF_WORKING_DIR: terraform

jobs:
  # ===== Job 1: VALIDATE =====
  # Static checks without AWS credentials.
  validate:
    name: Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      # Check that all .tf files follow canonical formatting.
      - name: Terraform fmt
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform fmt -check -recursive

      # Initialize without backend -- just need providers for validation.
      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

  # ===== Job 2: SECURITY SCAN =====
  # tfsec + Checkov with strict mode (soft_fail=false).
  # Must pass before any infrastructure changes are made.
  # No Trufflehog here -- that's for code changes (security-scan.yml).
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # tfsec: catches open security groups, unencrypted storage, etc.
      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ env.TF_WORKING_DIR }}
          soft_fail: false

      # Checkov: CIS benchmarks, AWS best practices.
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ env.TF_WORKING_DIR }}
          framework: terraform
          soft_fail: false

  # ===== Job 3: PROVISION =====
  # Applies Wave 1 then Wave 2 in dependency order.
  # Wave 1 includes github_oidc (idempotent -- safe to re-apply).
  provision:
    name: Provision Wave 1+2
    runs-on: ubuntu-latest
    needs: security-scan
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      # --- Wave 1 apply (base infrastructure) ---
      # VPC, Security Groups, ECR, S3, Cognito, and OIDC.
      # OIDC included here -- it's idempotent (no-op if already exists).
      - name: Plan Wave 1
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: |
          terraform plan \
            -target=module.vpc \
            -target=module.security_groups \
            -target=module.ecr \
            -target=module.s3 \
            -target=module.cognito \
            -target=module.github_oidc \
            -out=tfplan-wave1

      - name: Show plan Wave 1
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform show tfplan-wave1

      - name: Apply Wave 1
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: terraform apply tfplan-wave1

      # --- Wave 2 apply (RDS) ---
      # Depends on VPC subnets + security groups from Wave 1.
      - name: Plan Wave 2
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: |
          terraform plan \
            -target=module.rds \
            -out=tfplan-wave2

      - name: Show plan Wave 2
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform show tfplan-wave2

      - name: Apply Wave 2
        working-directory: ${{ env.TF_WORKING_DIR }}
        env:
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        run: terraform apply tfplan-wave2

      # --- Show all outputs after successful provision ---
      - name: Show outputs
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform output
