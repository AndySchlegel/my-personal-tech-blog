# Database initialization SQL scripts embedded as ConfigMap
#
# Contains schema creation (idempotent) and seed data.
# Mounted into the db-init Job (09-db-init-job.yaml) at /sql/.
# Source files: backend/src/models/schema.sql and backend/src/models/seed.sql
apiVersion: v1
kind: ConfigMap
metadata:
  name: db-init-scripts
  namespace: blog
  labels:
    app.kubernetes.io/part-of: techblog
data:
  # Schema creation -- safe to re-run (IF NOT EXISTS on all statements)
  01-schema.sql: |
    -- Database Schema for My Personal Tech Blog
    -- PostgreSQL on AWS RDS (db.t3.micro)
    -- Tables: users, categories, posts, tags, post_tags, comments

    CREATE TABLE IF NOT EXISTS users (
      id            SERIAL PRIMARY KEY,
      cognito_id    VARCHAR(255) UNIQUE NOT NULL,
      email         VARCHAR(255) UNIQUE NOT NULL,
      display_name  VARCHAR(100) NOT NULL,
      role          VARCHAR(20) DEFAULT 'admin',
      created_at    TIMESTAMP DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS categories (
      id            SERIAL PRIMARY KEY,
      name          VARCHAR(100) UNIQUE NOT NULL,
      slug          VARCHAR(100) UNIQUE NOT NULL,
      description   TEXT,
      created_at    TIMESTAMP DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS posts (
      id                    SERIAL PRIMARY KEY,
      title                 VARCHAR(255) NOT NULL,
      slug                  VARCHAR(255) UNIQUE NOT NULL,
      content               TEXT NOT NULL,
      excerpt               TEXT,
      cover_image_url       VARCHAR(500),
      status                VARCHAR(20) DEFAULT 'draft',
      featured              BOOLEAN DEFAULT FALSE,
      reading_time_minutes  INTEGER DEFAULT 0,
      view_count            INTEGER DEFAULT 0,
      author_id             INTEGER REFERENCES users(id),
      category_id           INTEGER REFERENCES categories(id),
      published_at          TIMESTAMP,
      created_at            TIMESTAMP DEFAULT NOW(),
      updated_at            TIMESTAMP DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_posts_slug ON posts(slug);
    CREATE INDEX IF NOT EXISTS idx_posts_published ON posts(status, published_at DESC);

    CREATE TABLE IF NOT EXISTS tags (
      id            SERIAL PRIMARY KEY,
      name          VARCHAR(100) UNIQUE NOT NULL,
      slug          VARCHAR(100) UNIQUE NOT NULL,
      source        VARCHAR(20) DEFAULT 'manual',
      created_at    TIMESTAMP DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS post_tags (
      post_id       INTEGER REFERENCES posts(id) ON DELETE CASCADE,
      tag_id        INTEGER REFERENCES tags(id) ON DELETE CASCADE,
      confidence    REAL,
      PRIMARY KEY (post_id, tag_id)
    );

    CREATE TABLE IF NOT EXISTS comments (
      id              SERIAL PRIMARY KEY,
      post_id         INTEGER REFERENCES posts(id) ON DELETE CASCADE,
      author_name     VARCHAR(100) NOT NULL,
      author_email    VARCHAR(255),
      content         TEXT NOT NULL,
      sentiment       VARCHAR(20),
      sentiment_score REAL,
      status          VARCHAR(20) DEFAULT 'pending',
      created_at      TIMESTAMP DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_comments_post ON comments(post_id, created_at DESC);

  # Seed data -- deletes and re-inserts (idempotent via transaction)
  02-seed.sql: |
    BEGIN;

    -- Clean up (safe to re-run)
    DELETE FROM post_tags;
    DELETE FROM comments;
    DELETE FROM posts;
    DELETE FROM tags;
    DELETE FROM categories;
    DELETE FROM users;

    -- Reset auto-increment counters
    ALTER SEQUENCE users_id_seq RESTART WITH 1;
    ALTER SEQUENCE categories_id_seq RESTART WITH 1;
    ALTER SEQUENCE posts_id_seq RESTART WITH 1;
    ALTER SEQUENCE tags_id_seq RESTART WITH 1;
    ALTER SEQUENCE comments_id_seq RESTART WITH 1;

    -- User
    INSERT INTO users (cognito_id, email, display_name, role)
    VALUES ('seed-admin-placeholder', 'andy@schlegel.dev', 'Andy Schlegel', 'admin');

    -- Categories
    INSERT INTO categories (name, slug, description) VALUES
      ('AWS & Cloud',           'aws-cloud',      'AWS Certifications, Cloud Architecture and Best Practices'),
      ('DevOps & CI/CD',        'devops',          'CI/CD, Docker, Kubernetes and Infrastructure as Code'),
      ('Homelab & Self-Hosting', 'homelab',         'NAS Setup, Self-Hosted Services and Homelab Projects'),
      ('Networking & Security',  'networking',      'VPN, Reverse Proxy, DNS and Security Best Practices'),
      ('Tools & Productivity',   'tools',           'Development Tools, Terminal Setup and Workflow Automation'),
      ('Certifications',         'certifications',  'Certifications, Study Plans and Exam Tips');

    -- Tags
    INSERT INTO tags (name, slug, source) VALUES
      ('Synology',      'synology',      'manual'),
      ('NAS',           'nas',           'manual'),
      ('Docker',        'docker',        'manual'),
      ('Homelab',       'homelab',       'manual'),
      ('DevOps',        'devops',        'manual'),
      ('AWS',           'aws',           'manual'),
      ('Certification', 'certification', 'manual'),
      ('Cloud',         'cloud',         'manual'),
      ('Learning',      'learning',      'manual'),
      ('Tailscale',     'tailscale',     'manual'),
      ('Traefik',       'traefik',       'manual'),
      ('VPN',           'vpn',           'manual'),
      ('Networking',    'networking',    'manual'),
      ('n8n',           'n8n',           'manual'),
      ('Automation',    'automation',    'manual'),
      ('Hetzner',       'hetzner',       'manual'),
      ('Self-Hosting',  'self-hosting',  'manual'),
      ('Monitoring',    'monitoring',    'manual'),
      ('Dashboard',     'dashboard',     'manual'),
      ('GitHub',        'github',        'manual'),
      ('Git',           'git',           'manual'),
      ('Terminal',      'terminal',      'manual'),
      ('Productivity',  'productivity',  'manual'),
      ('DNS',           'dns',           'manual'),
      ('Nginx',         'nginx',         'manual'),
      ('Linux',         'linux',         'manual'),
      ('Best Practices','best-practices','manual'),
      ('Production',    'production',    'manual');

    -- Post 1: Synology DS925+ Setup Guide (featured)
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'Synology DS925+ als DevOps Homelab: Der komplette Setup-Guide',
      'synology-ds925-devops-homelab-setup',
      'Die Synology DS925+ ist die perfekte Platform fuer DevOps Engineers. Mit AMD Ryzen V1500B (4 Cores), bis zu 32GB RAM und nativer Docker-Unterstuetzung bietet sie genug Power fuer produktive Workloads.

    ## Setup in 5 Schritten

    1. **Initial Setup**: Synology Assistant findet NAS automatisch, DSM 7.2 Installation dauert ca. 15 Min
    2. **Storage Pool**: RAID 5 fuer Balance zwischen Performance und Redundanz
    3. **Container Manager**: Docker aus Package Center installieren
    4. **SSH aktivieren**: Fuer Automation und Deployment
    5. **Erste Projekte**: Blog-App, Dashy, n8n deployen

    Der Container Manager macht Docker-Deployment super einfach. Alternativ bietet Portainer mehr Features fuer fortgeschrittene Setups.',
      'Vom Unboxing bis zum ersten Docker-Container: Wie ich meine Synology DS925+ als zentrale Homelab-Platform eingerichtet habe.',
      'published', true, 8, 1, 3,
      '2026-01-10T10:00:00Z'
    );

    -- Post 2: AWS Cloud Practitioner (featured)
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'AWS Cloud Practitioner: Von Null zur Zertifizierung in 6 Wochen',
      'aws-cloud-practitioner-guide',
      'Die AWS Cloud Practitioner (CLF-C02) ist der perfekte Einstieg in AWS. Nach 6 Wochen Vorbereitung habe ich mit 850/1000 Punkten bestanden.

    ## Mein Lernplan

    **Woche 1-2**: AWS Skill Builder Exam Prep (kostenlos) + "Overview of AWS" Whitepaper
    **Woche 3-4**: Udemy Kurs von Stephane Maarek + Hands-on im Free Tier
    **Woche 5**: Tutorials Dojo Practice Tests (6 Sets)
    **Woche 6**: Final Review aller Notizen

    ## Die 4 Exam-Domains

    1. Cloud Concepts (24%) - Shared Responsibility Model, 6 R''s of Migration
    2. Security & Compliance (30%) - IAM, GuardDuty, Shield, WAF
    3. Technology & Services (34%) - EC2, S3, RDS, Lambda, VPC
    4. Billing & Pricing (12%) - Support Plans, Cost Explorer

    **Pro-Tipp**: Practice Exams sind Gold wert! Mindestens 3-4 vollstaendige Tests machen.',
      'Mein kompletter Lernplan, Best Practices und Exam-Tipps fuer die AWS Cloud Practitioner Zertifizierung.',
      'published', true, 12, 1, 6,
      '2026-01-15T10:00:00Z'
    );

    -- Post 3: Tailscale + Traefik (featured)
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'Tailscale VPN + Traefik: Sichere Homelab-Cloud Verbindung',
      'tailscale-traefik-setup',
      'Mit Tailscale VPN und Traefik Reverse Proxy verbinde ich meine Synology NAS sicher mit einem Hetzner Cloud Server - ohne Port Forwarding am Router.

    ## Die Architektur

    Internet -> Cloudflare DNS -> Hetzner VPS (Public IP) -> Traefik -> Tailscale VPN -> Synology NAS (privat)

    ## Vorteile

    - Keine offenen Ports am Router
    - End-to-End Encryption via Tailscale
    - Automatische SSL-Zertifikate (Let''s Encrypt)
    - NAT Traversal - funktioniert auch hinter Firewall

    ## Setup in 6 Schritten

    1. Tailscale auf Hetzner & Synology installieren
    2. Traefik Docker Container auf Hetzner
    3. Services auf NAS fuer Tailscale exposen
    4. Traefik Labels fuer Routing konfigurieren
    5. DNS A-Record auf Hetzner IP setzen
    6. Let''s Encrypt HTTPS aktivieren

    **Kosten**: ~4 EUR/Monat fuer unbegrenzte Services!',
      'Kein Port Forwarding, keine oeffentliche IP - trotzdem sicher auf alle Services zugreifen.',
      'published', true, 15, 1, 4,
      '2026-01-20T10:00:00Z'
    );

    -- Post 4: n8n Self-Hosting
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'n8n Self-Hosting auf Hetzner: Workflow-Automation fuer unter 5 EUR/Monat',
      'n8n-hetzner-selfhosting',
      'n8n ist eine maechtige Open-Source Alternative zu Zapier. Self-Hosted auf Hetzner kostet es nur ~3,79 EUR/Monat statt 20 EUR+ bei Cloud-Anbietern.

    ## Warum Self-Hosting?

    - Unbegrenzte Workflows
    - Volle Datenkontrolle
    - Custom Nodes moeglich
    - 10x guenstiger als Cloud

    Nach 10 Minuten Setup laeuft n8n produktiv mit HTTPS!',
      'Wie ich n8n auf einem Hetzner Cloud Server deployed habe - mit Docker, Traefik und automatischem SSL.',
      'published', false, 10, 1, 5,
      '2026-01-25T10:00:00Z'
    );

    -- Post 5: Dashy Dashboard
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'Dashy Homelab Dashboard: Alle Services auf einen Blick',
      'dashy-homelab-dashboard',
      'Dashy ist das perfekte Dashboard fuer dein Homelab. Selbst-gehostet, Open-Source, und unglaublich customizable.

    **Deployment-Zeit**: Unter 5 Minuten fuer ein professionelles Dashboard!',
      'Mit Dashy alle Self-Hosted Services uebersichtlich organisieren - inklusive Status-Checks und modernem Design.',
      'published', false, 6, 1, 3,
      '2026-01-28T10:00:00Z'
    );

    -- Post 6: GitHub Foundations
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'GitHub Foundations Certification: Der komplette Study Guide',
      'github-foundations-certification',
      'Die GitHub Foundations Certification validiert dein Grundwissen ueber Git, GitHub, und Collaboration-Workflows.

    **Pro-Tipp**: Hands-on Erfahrung ist wichtiger als nur Theorie - erstelle eigene Repos und nutze alle Features!',
      'Alles was du fuer die GitHub Foundations Zertifizierung wissen musst - kostenlos fuer Studenten!',
      'published', false, 9, 1, 6,
      '2026-02-01T10:00:00Z'
    );

    -- Post 7: iTerm2 + Starship Terminal
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'iTerm2 + Starship: Das ultimative Terminal-Setup fuer Mac',
      'iterm2-starship-setup',
      'Ein gut konfiguriertes Terminal macht den Unterschied zwischen Frust und Flow.

    **Warum Starship statt Powerlevel10k?** Powerlevel10k ist on Life Support - Starship ist aktiv maintained und schneller!',
      'Von langweiligem Terminal zu produktivem Workspace - mit iTerm2, Oh-My-Zsh, und Starship.',
      'published', false, 7, 1, 5,
      '2026-02-03T10:00:00Z'
    );

    -- Post 8: Domain Setup
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'Domain Setup: Ionos vs. Infomaniak - Was ich gelernt habe',
      'domain-setup-ionos-infomaniak',
      'Fuer meine Self-Hosting Projekte nutze ich Domains von Ionos und Infomaniak.

    Beide funktionieren einwandfrei mit Cloudflare als DNS-Provider!',
      'Eigene Domains registrieren und konfigurieren - mit Ionos und Infomaniak im Vergleich.',
      'published', false, 5, 1, 4,
      '2026-02-05T10:00:00Z'
    );

    -- Post 9: AWS SAA Lernplan
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'AWS Solutions Architect Associate: Mein Lernplan',
      'aws-solutions-architect-learning-path',
      'Nach dem Cloud Practitioner ist der AWS Solutions Architect Associate der naechste logische Schritt.',
      'Von Cloud Practitioner zu Solutions Architect - wie ich die SAA-C03 Pruefung vorbereite.',
      'published', false, 10, 1, 6,
      '2026-02-08T10:00:00Z'
    );

    -- Post 10: Docker Compose Best Practices
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'Docker Compose Best Practices fuer Production',
      'docker-compose-production-best-practices',
      'Docker Compose ist perfekt fuer Development, aber Production braucht Extra-Konfiguration.

    **Pro-Tipp**: Nutze docker-compose.override.yml fuer local Development Overrides!',
      'Von Development zu Production - wie ich Docker Compose Setups production-ready mache.',
      'published', false, 8, 1, 2,
      '2026-02-10T10:00:00Z'
    );

    -- Post 11: Linux Essentials
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'Linux Essentials Certification: Was bringt es wirklich?',
      'linux-essentials-certification-review',
      'Die Linux Essentials Zertifizierung von LPI ist ein guter Einstieg in Linux.

    **Mein Tipp**: Lern Linux hands-on mit eigenem Server/NAS - praktische Erfahrung ist mehr wert als ein Zertifikat!',
      'Meine Erfahrung mit der LPI Linux Essentials Zertifizierung - und ob sie sich lohnt.',
      'published', false, 6, 1, 6,
      '2026-02-13T10:00:00Z'
    );

    -- Post 12: Traefik vs Nginx
    INSERT INTO posts (title, slug, content, excerpt, status, featured, reading_time_minutes, author_id, category_id, published_at)
    VALUES (
      'Traefik vs. Nginx: Welcher Reverse Proxy fuer Homelab?',
      'traefik-vs-nginx-comparison',
      'Beide sind exzellent - aber sie haben unterschiedliche Staerken.

    **Mein Setup**: Traefik fuer Homelab (wegen Auto-SSL), nginx fuer statische Sites.',
      'Der grosse Vergleich: Traefik oder Nginx als Reverse Proxy fuer Self-Hosting Projekte.',
      'published', false, 7, 1, 2,
      '2026-02-15T10:00:00Z'
    );

    -- Post-Tag links
    INSERT INTO post_tags (post_id, tag_id) VALUES
      (1, 1), (1, 2), (1, 3), (1, 4), (1, 5),
      (2, 6), (2, 7), (2, 8), (2, 9),
      (3, 10), (3, 11), (3, 12), (3, 13), (3, 4),
      (4, 14), (4, 15), (4, 16), (4, 17), (4, 3),
      (5, 19), (5, 4), (5, 3), (5, 18),
      (6, 20), (6, 7), (6, 21), (6, 9), (6, 5),
      (7, 22), (7, 23),
      (8, 24), (8, 13),
      (9, 6), (9, 7), (9, 8), (9, 9),
      (10, 3), (10, 5), (10, 28), (10, 27),
      (11, 26), (11, 7), (11, 9),
      (12, 11), (12, 25), (12, 4), (12, 3);

    COMMIT;
